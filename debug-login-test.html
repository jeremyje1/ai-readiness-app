<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login Debug Test</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .log { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 4px; }
        .error { background: #ffebee; color: #c62828; }
        .success { background: #e8f5e9; color: #2e7d32; }
        .info { background: #e3f2fd; color: #1565c0; }
        input, button { display: block; margin: 10px 0; padding: 8px; width: 300px; }
        button { width: 316px; background: #1976d2; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:disabled { background: #ccc; cursor: not-allowed; }
    </style>
</head>
<body>
    <h1>Login Debug Test</h1>
    
    <form id="loginForm">
        <input type="email" id="email" placeholder="Email" value="jeremy.estrella@gmail.com" required>
        <input type="password" id="password" placeholder="Password" value="TempPassword123!" required>
        <button type="submit" id="submitBtn">Sign In</button>
    </form>

    <div id="logs"></div>

    <script>
        // Initialize with environment values - you'll need to replace these with your actual values
        const SUPABASE_URL = 'https://jocigzsthcpspxfdfxae.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_vGhE-98PSkfGraQUnJJGIw_BHM5MV6Q';

        function log(message, type = 'info') {
            const timestamp = new Date().toISOString();
            const logDiv = document.createElement('div');
            logDiv.className = `log ${type}`;
            logDiv.innerHTML = `<strong>${timestamp}:</strong> ${message}`;
            document.getElementById('logs').appendChild(logDiv);
            console.log(`[${timestamp}] ${message}`);
        }

        function testDirectRestApi(email, password) {
            log('Testing direct REST API authentication...', 'info');
            
            return fetch(`${SUPABASE_URL}/auth/v1/token?grant_type=password`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'apikey': SUPABASE_ANON_KEY
                },
                body: JSON.stringify({ email, password })
            })
            .then(response => {
                log(`REST API response status: ${response.status}`, response.ok ? 'success' : 'error');
                return response.json();
            })
            .then(data => {
                if (data.access_token) {
                    log('REST API authentication successful!', 'success');
                    log(`User ID: ${data.user?.id}`, 'info');
                    log(`Email: ${data.user?.email}`, 'info');
                    return { success: true, data };
                } else {
                    log(`REST API authentication failed: ${data.error || data.msg || 'Unknown error'}`, 'error');
                    return { success: false, error: data.error || data.msg };
                }
            })
            .catch(error => {
                log(`REST API request failed: ${error.message}`, 'error');
                return { success: false, error: error.message };
            });
        }

        function testSupabaseSDK(email, password) {
            log('Testing Supabase SDK authentication...', 'info');
            
            if (!SUPABASE_ANON_KEY) {
                log('Supabase anon key not provided - skipping SDK test', 'error');
                return Promise.resolve({ success: false, error: 'No anon key' });
            }

            const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            
            // Add timeout
            const timeoutPromise = new Promise((_, reject) => {
                setTimeout(() => reject(new Error('SDK timeout after 10 seconds')), 10000);
            });

            const authPromise = supabase.auth.signInWithPassword({ email, password });

            return Promise.race([authPromise, timeoutPromise])
                .then(({ data, error }) => {
                    if (error) {
                        log(`SDK authentication failed: ${error.message}`, 'error');
                        return { success: false, error: error.message };
                    } else {
                        log('SDK authentication successful!', 'success');
                        log(`User ID: ${data.user?.id}`, 'info');
                        log(`Session: ${data.session ? 'Present' : 'Missing'}`, 'info');
                        return { success: true, data };
                    }
                })
                .catch(error => {
                    log(`SDK authentication error: ${error.message}`, 'error');
                    return { success: false, error: error.message };
                });
        }

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const submitBtn = document.getElementById('submitBtn');
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'Testing...';
            
            document.getElementById('logs').innerHTML = '';
            
            log(`Starting authentication test for: ${email}`, 'info');
            
            // Test both methods
            const restResult = await testDirectRestApi(email, password);
            const sdkResult = await testSupabaseSDK(email, password);
            
            // Summary
            log('=== TEST SUMMARY ===', 'info');
            log(`REST API: ${restResult.success ? '✅ Working' : '❌ Failed'}`, restResult.success ? 'success' : 'error');
            log(`SDK: ${sdkResult.success ? '✅ Working' : '❌ Failed'}`, sdkResult.success ? 'success' : 'error');
            
            if (restResult.success && !sdkResult.success) {
                log('⚠️ SDK is failing but REST API works - this suggests a client-side issue', 'error');
            } else if (!restResult.success && !sdkResult.success) {
                log('❌ Both methods failed - check credentials or Supabase configuration', 'error');
            } else if (restResult.success && sdkResult.success) {
                log('✅ Both methods working - the issue may be in the React application', 'success');
            }
            
            submitBtn.disabled = false;
            submitBtn.textContent = 'Sign In';
        });

        // Initial page load test
        log('Debug page loaded. Make sure to add your Supabase anon key in the script.', 'info');
        log(`Testing with Supabase URL: ${SUPABASE_URL}`, 'info');
    </script>
</body>
</html>