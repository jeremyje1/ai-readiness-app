name: Password Token Cleanup

on:
  schedule:
    # Runs hourly at minute 5 (adjust schedule as required)
    - cron: '5 * * * *'
  workflow_dispatch: {}

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Invoke cleanup endpoint (header-auth)
        env:
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
          APP_BASE_URL: ${{ secrets.APP_BASE_URL }}
        run: |
          BASE_URL="$APP_BASE_URL"
          if [ -z "$BASE_URL" ]; then
            echo "‚ö†Ô∏è  APP_BASE_URL secret not configured in GitHub Secrets" >&2
            echo "üìã To configure: https://github.com/${{ github.repository }}/settings/secrets/actions" >&2
            echo "üìñ See SECRETS_QUICKSTART.md for setup instructions" >&2
            exit 1
          fi
          if [ -z "$CRON_SECRET" ]; then
            echo "‚ö†Ô∏è  CRON_SECRET GitHub secret not configured" >&2
            echo "üìã To configure: https://github.com/${{ github.repository }}/settings/secrets/actions" >&2
            echo "üìñ See SECRETS_QUICKSTART.md for setup instructions" >&2
            exit 1
          fi
          echo "üßπ Calling cleanup endpoint at $BASE_URL/api/auth/password/setup/cleanup"
          http_code=$(curl -s -o response.json -w '%{http_code}' -X POST "$BASE_URL/api/auth/password/setup/cleanup" \
            -H "x-cron-secret: $CRON_SECRET" -H 'content-length: 0')
          echo "üìä Status: $http_code"
          echo "üìÑ Response:" && cat response.json
          if [ "$http_code" -ge 300 ]; then
            echo "‚ùå Request failed with status $http_code" >&2
            exit 1
          fi
          echo "‚úÖ Cleanup request successful"

      - name: Validate response
        run: |
          if ! grep -q '"success":true' response.json; then
            echo '‚ùå Success flag not found in response' >&2
            cat response.json
            exit 1
          fi
          deleted=$(grep -E '"deleted":' response.json | sed -E 's/.*"deleted":[ ]*([0-9]+).*/\1/') || true
          if [ -z "$deleted" ]; then
            echo "‚ÑπÔ∏è  No deleted field present (function may return void)" 
          else
            echo "‚úÖ Deleted tokens: $deleted"
          fi
